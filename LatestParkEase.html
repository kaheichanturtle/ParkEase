<!-- 
License

Copyright 2025 Ka Hei Chan and Shellcraft Studios. Unauthorized copying is prohibited.

ParkEase and all associated content, code, and intellectual property are protected under copyright law. Unauthorized use, reproduction, distribution, or modification of this project, in whole or in part, is strictly prohibited without prior written consent from the copyright holder.

Permissions
- Viewing: You are allowed to view the content and code for personal or educational purposes.
- Forking: Forking this repository is not allowed. Please contact me at 2uh114cu@duck.me 

Restrictions
- Commercial Use: You may not use this project or any derivative works for commercial purposes without explicit permission.
- Distribution: You may not distribute, publish, or sell any part of this project without prior written consent.
- Modification: You may not modify, adapt, or create derivative works without explicit permission.

Attribution
If you use or reference this project in any way, you must provide proper attribution by linking back to the original repository:  
[ParkEase Repository](https://github.com/kaheichanturtle/Parkease)

Legal Notice
Any unauthorized use of this project may result in legal action. For inquiries regarding permissions, licensing, or collaborations, please contact us at 2uh114cu@duck.com.

---
Copyright © 2025 Ka Hei Chan. All rights reserved.

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ParkEase</title>
    <meta name="theme-color" content="#4a90e2" />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="apple-touch-icon"
      href="https://cdn.glitch.global/cbdf53ed-1d1e-441b-8c47-ff223e3a04c8/android-launchericon-192-192.png?v=1741136144106"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="https://cdn.glitch.global/cbdf53ed-1d1e-441b-8c47-ff223e3a04c8/android-launchericon-192-192.png?v=1741136144106"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --primary: #4a90e2;
        --primary-light: #7eb4ff;
        --primary-dark: #2d6fc8;
        --text: #333333;
        --text-light: #666666;
        --background: #f8f9fa;
        --card: #ffffff;
        --success: #34c759;
        --warning: #ffcc00;
        --danger: #ff3b30;
        --disabled-blue: #007bff;
        --gray: #e0e0e0;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --radius: 12px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --bottom-nav-height: 60px;
      }
      body.dark-mode {
        --primary: #58a6ff;
        --primary-light: #79b8ff;
        --primary-dark: #388bfd;
        --text: #c9d1d9;
        --text-light: #8b949e;
        --background: #0d1117;
        --card: #161b22;
        --success: #238636;
        --warning: #e3b341;
        --danger: #da3633;
        --disabled-blue: #1f6feb;
        --gray: #21262d;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }
      html,
      body {
        height: 100%;
        overflow: hidden;
      }
      body {
        background-color: var(--background);
        color: var(--text);
        overscroll-behavior-y: contain;
        transition: background-color 0.3s, color 0.3s;
      }

      /* --- Install Gate --- */
      #install-gate {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--background);
        color: var(--text);
        display: flex; /* Changed to flex by default, JS hides if installed */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 30px;
        text-align: center;
        z-index: 2000; /* Highest */
        transition: opacity 0.5s ease-out; /* Optional fade out */
      }
      #install-gate h2 {
        color: var(--primary);
        margin-bottom: 15px;
        font-size: 24px;
      }
      #install-gate p {
        margin-bottom: 25px;
        line-height: 1.6;
        font-size: 16px;
        max-width: 400px;
        color: var(--text-light);
      }
      .install-instructions {
        display: none; /* Hide sections initially */
        padding: 20px;
        background-color: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-top: 20px;
      }
      .install-instructions h3 {
        margin-bottom: 15px;
        font-size: 18px;
        color: var(--primary);
      }
      .install-instructions p {
        font-size: 14px;
        margin-bottom: 15px;
        color: var(--text);
      }
      .install-instructions svg {
        /* Style for iOS share icon */
        display: inline-block;
        vertical-align: middle;
        margin: 0 4px;
        width: 22px; /* Slightly larger */
        height: 22px;
        stroke: var(--primary); /* Use primary color for icon */
      }
      #install-btn-android {
        /* Style the Android button */
        /* Uses .button .primary-button styles */
      }

      .app-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        max-width: 500px;
        margin: 0 auto;
        background-color: var(--background);
        position: relative;
        /* Initially hidden if install gate is shown */
        /* visibility: hidden;  Might cause layout issues, prefer gate overlay */
      }

      /* --- Main Content Area --- */
      .main-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: calc(var(--bottom-nav-height) + 16px);
      }

      /* --- PWA Install Banner (REMOVED - Replaced by Install Gate) --- */

      /* Other styles remain largely the same... */
      #camera-section,
      #map-section {
        margin-bottom: 16px;
      }
      #map-section {
        display: none;
        height: 250px;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      #map {
        height: 100%;
        width: 100%;
      }
      #video,
      #capturedImage {
        width: 100%;
        max-height: 500px;
        object-fit: cover;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        background: var(--gray);
        transition: var(--transition);
        display: block;
      }
      #capturedImage {
        display: none;
      }
      .button-container {
        padding: 0 0 16px 0;
      }
      .button {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: var(--radius);
        margin-top: 12px;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        color: white;
        outline: none;
      }
      .button svg {
        margin-right: 8px;
        flex-shrink: 0;
      }
      .primary-button {
        background: var(--primary);
      }
      .primary-button:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .danger-button {
        background: var(--danger);
      }
      .danger-button:hover {
        background: color-mix(in srgb, var(--danger) 90%, black);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      #captureBtn {
        display: flex;
      }
      #retakeBtn {
        display: none;
      }
      .sign-container {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        opacity: 0;
        transform: translateY(20px);
        transition: var(--transition);
        height: 0;
        overflow: hidden;
      }
      .sign-container.visible {
        opacity: 1;
        transform: translateY(0);
        height: auto;
      }
      .sign-card {
        flex: 1;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        background: var(--card);
        transition: var(--transition);
      }
      .sign-header {
        padding: 10px 12px;
        color: white;
        font-weight: 600;
        text-align: center;
        font-size: 11px;
        line-height: 1.3;
      }
      .allowed {
        background: var(--success);
      }
      .ticket {
        background: var(--warning);
        color: #333 !important;
      }
      .no-parking {
        background: var(--danger);
      }
      .disabled-allowed {
        background: var(--disabled-blue);
      }
      .sign-body {
        padding: 12px 16px;
      }
      .sign-row {
        display: flex;
        margin-bottom: 6px;
        font-size: 12px;
      }
      .sign-label {
        flex: 0 0 60px;
        font-weight: 600;
        color: var(--text-light);
      }
      .sign-value {
        flex: 1;
        color: var(--text);
      }
      .timer-card-container {
        position: relative;
        margin-bottom: 25px;
      }
      .timer-card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        text-align: center;
        transition: var(--transition);
        display: none;
      }
      .timer-label {
        font-size: 14px;
        color: var(--text-light);
        margin-bottom: 8px;
      }
      .time-display {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 8px;
      }
      .expires-at {
        font-size: 14px;
        color: var(--text-light);
      }
      #stopTimerBtn {
        display: none;
        position: absolute;
        bottom: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        min-width: 120px;
        background-color: var(--danger);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 10px 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: var(--shadow);
        z-index: 10;
        transition: var(--transition);
      }
      #stopTimerBtn:hover {
        background-color: color-mix(in srgb, var(--danger) 85%, black);
      }
      #aiDetailsSection {
        margin-bottom: 16px;
        display: none;
      }
      .collapsible {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 12px 16px;
        background: var(--gray);
        border: none;
        text-align: left;
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        margin-top: 8px;
      }
      .collapsible:hover {
        background: color-mix(in srgb, var(--gray) 90%, black);
      }
      .chevron {
        transition: var(--transition);
      }
      .collapsible.active .chevron {
        transform: rotate(180deg);
      }
      .content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background: var(--card);
        border-radius: 0 0 var(--radius) var(--radius);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .ai-response {
        padding: 16px;
        font-size: 13px;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-x: auto;
        background: var(--background);
        border-radius: var(--radius);
        margin: 12px;
        border: 1px solid var(--gray);
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }
      .modal.visible {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        width: 90%;
        max-width: 400px;
        background: var(--card);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 85vh;
        overflow-y: auto;
        position: relative;
      }
      .modal.visible .modal-content {
        transform: scale(1);
      }
      .modal-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
        color: var(--text);
      }
      .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-light);
        cursor: pointer;
        line-height: 1;
        padding: 5px;
      }
      .modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
      }
      .modal-button {
        flex: 1;
      }
      #ticket-time-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 10px;
      }
      .time-option-btn {
        background-color: var(--gray);
        color: var(--text);
        padding: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
        text-align: center;
      }
      .time-option-btn:hover {
        background-color: var(--primary);
        color: white;
      }
      #settings-modal .modal-content {
      }
      .settings-section {
        margin-bottom: 20px;
        border-bottom: 1px solid var(--gray);
        padding-bottom: 16px;
      }
      .settings-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }
      .settings-section h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--primary);
      }
      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .setting-item label {
        font-size: 14px;
        color: var(--text);
        margin-right: 10px;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
        flex-shrink: 0;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--gray);
        transition: 0.4s;
        border-radius: 20px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--primary);
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      #historyModal .modal-content {
      }
      #history-list {
        list-style: none;
        padding: 0;
      }
      #history-list li {
        background: var(--background);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid var(--gray);
      }
      #history-list li:hover {
        background: var(--gray);
      }
      .history-entry span {
        display: block;
        margin-bottom: 4px;
      }
      .history-entry .date {
        font-weight: 600;
      }
      .history-entry .details {
        color: var(--text-light);
        font-size: 12px;
      }
      #history-detail-modal .modal-content {
      }
      #history-detail-map {
        height: 150px;
        width: 100%;
        margin-bottom: 10px;
        border-radius: var(--radius);
      }
      #history-detail-content p {
        margin-bottom: 8px;
        font-size: 14px;
      }
      .status-message {
        position: fixed;
        bottom: calc(var(--bottom-nav-height) + 10px);
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 24px;
        box-shadow: var(--shadow);
        z-index: 900;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        pointer-events: none;
        opacity: 0;
        text-align: center;
        max-width: 90%;
        transform: translateX(-50%) translateY(100px);
      }
      .status-message.visible {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      .fade-in {
        animation: fadeIn 0.5s forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .pulse {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0
            color-mix(in srgb, var(--primary) 40%, transparent);
        }
        70% {
          box-shadow: 0 0 0 10px
            color-mix(in srgb, var(--primary) 0%, transparent);
        }
        100% {
          box-shadow: 0 0 0 0 color-mix(in srgb, var(--primary) 0%, transparent);
        }
      }
      .current-location-marker {
        background-color: #3498db;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      }
      .saved-location-marker {
        background-color: #e74c3c;
        width: 20px;
        height: 20px;
        border-radius: 50% 50% 50% 0;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        transform: rotate(-45deg);
      }
      .leaflet-div-icon {
        background: none;
        border: none;
      }
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 500px;
        margin: 0 auto;
        height: var(--bottom-nav-height);
        background-color: var(--card);
        display: flex;
        justify-content: space-around;
        align-items: center;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        border-top: 1px solid var(--gray);
        z-index: 600;
      }
      .nav-btn {
        background: none;
        border: none;
        color: var(--text-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 10px;
        padding: 6px 10px;
        cursor: pointer;
        transition: color 0.2s;
        flex-grow: 1;
        height: 100%;
      }
      .nav-btn svg {
        width: 24px;
        height: 24px;
        margin-bottom: 4px;
      }
      .nav-btn.active,
      .nav-btn:hover {
        color: var(--primary);
      }
    </style>
  </head>
  <body>
    <!-- Install Gate - Shown Only if Not Installed -->
    <div id="install-gate">
      <h2>Welcome to ParkEase</h2>
      <p>
        For the best experience, including ensuring background functionality for accurate timers and better battery optimisation, please
        install the ParkEase app to your Home Screen.
      </p>

      <!-- iOS Install Instructions -->
      <div id="ios-install-prompt" class="install-instructions">
        <h3>Install on iOS</h3>
        <p>
          Tap the Share button
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 3V15M8 6L12 2L16 6M5 9V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V9"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          in your browser menu, then scroll down and select 'Add to Home
          Screen'.
        </p>
      </div>

      <!-- Android Install Instructions -->
      <div id="android-install-prompt" class="install-instructions">
        <h3>Install on Android</h3>
        <p>Tap the button below to add ParkEase to your device.</p>
        <button id="install-btn-android" class="button primary-button" disabled>
          Checking availability...
        </button>
      </div>

      <!-- Fallback for other OS -->
      <div id="other-os-prompt" class="install-instructions">
        <h3>Installation</h3>
        <p>
          Please continue on mobile by scanning this QR code. (On mobile? Use Safari on IOS or Chrome on Android and try again.)
        </p>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=www.parkease.glitch.me" alt="ParkEase QR Code">
      
      </div>
    </div>

    <!-- Main App Container (Content loaded only if installed) -->
    <div class="app-container">
      <!-- Main Content Scrollable Area -->
      <div class="main-content">
        <!-- App Content Goes Here (Instructions, Camera, Map, Timer etc.) -->
        <!-- Instruction -->
        <div
          class="instruction fade-in"
          style="
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin-bottom: 16px;
            background: var(--primary-light);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-weight: 500;
          "
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            style="margin-right: 12px; flex-shrink: 0"
          >
            <path
              d="M12 16V12M12 8H12.01M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>Remember to turn up your device's volume for the alarm!</span>
        </div>
        <!-- Camera Section -->
        <div id="camera-section">
          <video id="video" autoplay playsinline muted></video>
          <img id="capturedImage" alt="Captured parking sign" />
          <canvas id="canvas" style="display: none"></canvas>
        </div>
        <!-- Map Section -->
        <div id="map-section"><div id="map"></div></div>
        <!-- Sign Graphs -->
        <div id="signGraphs" class="sign-container">
          <div class="sign-card" id="leftSignCard">
            <div class="sign-header" id="leftSignHeader">LEFT SIDE</div>
            <div class="sign-body">
              <div class="sign-row">
                <div class="sign-label">Time:</div>
                <div class="sign-value" id="leftTime">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Sign:</div>
                <div class="sign-value" id="leftSign">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Ticket:</div>
                <div class="sign-value" id="leftTicket">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Disabled:</div>
                <div class="sign-value" id="leftDisabled">-</div>
              </div>
            </div>
          </div>
          <div class="sign-card" id="rightSignCard">
            <div class="sign-header" id="rightSignHeader">RIGHT SIDE</div>
            <div class="sign-body">
              <div class="sign-row">
                <div class="sign-label">Time:</div>
                <div class="sign-value" id="rightTime">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Sign:</div>
                <div class="sign-value" id="rightSign">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Ticket:</div>
                <div class="sign-value" id="rightTicket">-</div>
              </div>
              <div class="sign-row">
                <div class="sign-label">Disabled:</div>
                <div class="sign-value" id="rightDisabled">-</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Timer Card Container -->
        <div id="timerCardContainer" class="timer-card-container">
          <div id="timerCard" class="card timer-card">
            <div class="timer-label">Time Until Reminder</div>
            <div id="warningTime" class="time-display">00:00:00</div>
            <div id="expiryTime" class="expires-at"></div>
          </div>
          <button id="stopTimerBtn">Stop Timer</button>
        </div>
        <!-- Action Buttons Container -->
        <div class="button-container">
          <button id="captureBtn" class="button primary-button">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M9 2L7.17 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4H16.83L15 2H9Z"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Capture Sign
          </button>
          <button id="retakeBtn" class="button danger-button">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M4 4V9H4.58152M19.9381 11C19.446 7.05369 16.0796 4 12 4C8.64262 4 5.76829 6.06817 4.58152 9M4.58152 9H9M20 20V15H19.4185M19.4185 15C18.2317 17.9318 15.3574 20 12 20C7.92038 20 4.55399 16.9463 4.06189 13M19.4185 15H15"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Retake Photo
          </button>
        </div>
        <!-- AI Details Collapsible (Initially hidden by CSS) -->
        <div id="aiDetailsSection">
          <button class="collapsible">
            <span>Show AI Response Details</span>
            <svg
              class="chevron"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6 9L12 15L18 9"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
          <div class="content">
            <pre class="ai-response" id="originalText"></pre>
          </div>
        </div>
      </div>
      <!-- End Main Content -->

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <button
          class="nav-btn active"
          id="navStatusBtn"
          aria-label="Current Status"
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M10 21H14C14 21.5523 13.5523 22 13 22H11C10.4477 22 10 21.5523 10 21Z"
              fill="currentColor"
            />
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M12 2C6.47715 2 2 6.47715 2 12C2 16.858 5.41123 20.7745 10 21.7225V21H14V21.7225C18.5888 20.7745 22 16.858 22 12C22 6.47715 17.5228 2 12 2ZM10.1455 15.0585C10.4079 15.4705 10.876 15.7135 11.3797 15.7135H12.6107C13.1144 15.7135 13.5825 15.4705 13.8449 15.0585L15.1609 12.9875L16.7529 12.0205C17.0999 11.8065 17.2499 11.3715 17.0909 10.9945C16.9339 10.6185 16.5299 10.4145 16.1349 10.5115L14.2009 11.0095L13.2829 9.5075C13.1049 9.2305 12.7839 9.0705 12.4339 9.0705H11.5569C11.2069 9.0705 10.8859 9.2305 10.7079 9.5075L9.7899 11.0095L7.8559 10.5115C7.4609 10.4145 7.0569 10.6185 6.8999 10.9945C6.7409 11.3715 6.8909 11.8065 7.2379 12.0205L8.8299 12.9875L10.1455 15.0585Z"
              fill="currentColor"
            />
          </svg>
          <span>Status</span>
        </button>
        <button class="nav-btn" id="navHistoryBtn" aria-label="Parking History">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 8V12L15 15M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>History</span>
        </button>
        <button class="nav-btn" id="navSettingsBtn" aria-label="Settings">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M4 21V14M4 10V3M12 21V12M12 8V3M20 21V16M20 12V3M1 14H7M9 8H15M17 16H23"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span>Settings</span>
        </button>
      </nav>

      <!-- Status Message Area -->
      <div id="status" class="status-message"></div>
    </div>
    <!-- End App Container -->

    <!-- Modals -->
    <div id="signSelectionModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">Which side did you park on?</div>
        <div class="modal-buttons">
          <button id="leftSignBtn" class="button primary-button modal-button">
            Left Side
          </button>
          <button id="rightSignBtn" class="button primary-button modal-button">
            Right Side
          </button>
        </div>
      </div>
    </div>
    <div id="ticketTimeModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">Ticket Required: Select Parking Duration</div>
        <p
          style="
            text-align: center;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 15px;
          "
        >
          Choose how long you plan to park.
        </p>
        <div id="ticket-time-options"></div>
        <button
          id="cancelTicketTimeBtn"
          class="button danger-button modal-button"
          style="margin-top: 20px"
        >
          Cancel
        </button>
      </div>
    </div>
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" id="closeSettingsBtn">×</button>
        <div class="modal-title">Settings</div>
        <div class="settings-section">
          <h3>Appearance</h3>
          <div class="setting-item">
            <label for="darkModeToggle">Dark Mode</label
            ><label class="toggle-switch"
              ><input type="checkbox" id="darkModeToggle" /><span
                class="slider"
              ></span
            ></label>
          </div>
        </div>
        <div class="settings-section">
          <h3>Accessibility</h3>
          <div class="setting-item">
            <label for="disabilityToggle">Disability Permit</label
            ><label class="toggle-switch"
              ><input type="checkbox" id="disabilityToggle" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <p style="font-size: 12px; color: var(--text-light); margin-top: 5px">
            Enable if you have a valid permit.
          </p>
        </div>
        <div class="settings-section">
          <h3>Advanced</h3>
          <div class="setting-item">
            <label for="showAiDetailsToggle">Show AI Response Details</label
            ><label class="toggle-switch"
              ><input type="checkbox" id="showAiDetailsToggle" /><span
                class="slider"
              ></span
            ></label>
          </div>
          <p style="font-size: 12px; color: var(--text-light); margin-top: 5px">
            Display the raw text output from the AI after analysis.
          </p>
        </div>
        <div class="settings-section">
          <h3>Disclaimer</h3>
          <p style="font-size: 14px; margin-bottom: 10px">
ParkEase may be inaccurate. Follow local laws to avoid fines. We are not liable for errors, and you waive any legal actions against us. More info: Terms and Conditions

          </p>
          <a
            href="https://parkease.glitch.me/terms.html"
            target="_blank"
            style="
              color: var(--primary);
              text-decoration: underline;
              font-size: 14px;
              display: block;
              margin-bottom: 10px;
            "
            >View Terms and Conditions</a
          >
          <p style="font-size: 10px; color: var(--text-light)">
            Version: 9.2 (PWA, Map, History) - Last updated: April 3, 2025
          </p>
          <p style="font-size: 10px; color: var(--text-light)">
            Made by KH @ <a
            href="https://shorturl.at/v8TYg"
            target="_blank"
            style="
              color: var(--primary)" > Shellcraft </a>
          </p>
        </div>
      </div>
    </div>
    <!-- History Modal -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" id="closeHistoryModalBtn">×</button>
        <div class="modal-title">Parking History</div>
        <ul id="history-list">
          <li style="text-align: center; color: var(--text-light)">
            Loading history...
          </li>
        </ul>
        <button
          id="clearHistoryBtn"
          class="button danger-button modal-button"
          style="font-size: 12px; padding: 8px; margin-top: 15px"
        >
          Clear History
        </button>
      </div>
    </div>
    <!-- History Detail Modal -->
    <div id="historyDetailModal" class="modal">
      <div class="modal-content">
        <button class="modal-close-btn" id="closeHistoryDetailBtn">×</button>
        <div class="modal-title">Parking Session Details</div>
        <div id="history-detail-map"></div>
        <div id="history-detail-content"></div>
      </div>
    </div>

    <!-- Audio Elements -->
    <audio
      id="silentAudio"
      loop
      src="https://cdn.glitch.global/16c2e168-5f80-4256-858b-ebbfd77da240/5-seconds-of-silence.mp3?v=1739673346964"
    ></audio>
    <audio
      id="alarmAudio"
      loop
      src="https://cdn.glitch.global/16c2e168-5f80-4256-858b-ebbfd77da240/5-seconds-of-silence.mp3?v=1739673346964"
    ></audio>

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // --- DOM Elements ---
      const body = document.body;
      const installGate = document.getElementById("install-gate"); // Install Gate Div
      const iosInstallPrompt = document.getElementById("ios-install-prompt");
      const androidInstallPrompt = document.getElementById(
        "android-install-prompt"
      );
      const otherOsPrompt = document.getElementById("other-os-prompt");
      const installBtnAndroid = document.getElementById("install-btn-android");
      const appContainer = document.querySelector(".app-container"); // Main app container
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const capturedImage = document.getElementById("capturedImage");
      const captureBtn = document.getElementById("captureBtn");
      const retakeBtn = document.getElementById("retakeBtn");
      const status = document.getElementById("status");
      const timerCardContainer = document.getElementById("timerCardContainer");
      const timerCard = document.getElementById("timerCard");
      const warningTimeEl = document.getElementById("warningTime");
      const expiryTimeEl = document.getElementById("expiryTime");
      const stopTimerBtn = document.getElementById("stopTimerBtn");
      const silentAudio = document.getElementById("silentAudio");
      const alarmAudio = document.getElementById("alarmAudio");
      const originalText = document.getElementById("originalText");
      const aiDetailsSection = document.getElementById("aiDetailsSection");
      const signSelectionModal = document.getElementById("signSelectionModal");
      const leftSignBtn = document.getElementById("leftSignBtn");
      const rightSignBtn = document.getElementById("rightSignBtn");
      const ticketTimeModal = document.getElementById("ticketTimeModal");
      const ticketTimeOptionsContainer = document.getElementById(
        "ticket-time-options"
      );
      const cancelTicketTimeBtn = document.getElementById(
        "cancelTicketTimeBtn"
      );
      const signGraphs = document.getElementById("signGraphs");
      const settingsModal = document.getElementById("settingsModal");
      const closeSettingsBtn = document.getElementById("closeSettingsBtn");
      const darkModeToggle = document.getElementById("darkModeToggle");
      const disabilityToggle = document.getElementById("disabilityToggle");
      const showAiDetailsToggle = document.getElementById(
        "showAiDetailsToggle"
      );
      const historyModal = document.getElementById("historyModal");
      const closeHistoryModalBtn = document.getElementById(
        "closeHistoryModalBtn"
      );
      const historyList = document.getElementById("history-list");
      const clearHistoryBtn = document.getElementById("clearHistoryBtn");
      const historyDetailModal = document.getElementById("historyDetailModal");
      const closeHistoryDetailBtn = document.getElementById(
        "closeHistoryDetailBtn"
      );
      const historyDetailMapEl = document.getElementById("history-detail-map");
      const historyDetailContent = document.getElementById(
        "history-detail-content"
      );
      const cameraSection = document.getElementById("camera-section");
      const mapSection = document.getElementById("map-section");
      const mapEl = document.getElementById("map");
      const navStatusBtn = document.getElementById("navStatusBtn");
      const navHistoryBtn = document.getElementById("navHistoryBtn");
      const navSettingsBtn = document.getElementById("navSettingsBtn");
      const allNavBtns = document.querySelectorAll(".nav-btn");
      const leftSignHeader = document.getElementById("leftSignHeader");
      const leftTime = document.getElementById("leftTime");
      const leftSign = document.getElementById("leftSign");
      const leftTicket = document.getElementById("leftTicket");
      const leftDisabled = document.getElementById("leftDisabled");
      const rightSignHeader = document.getElementById("rightSignHeader");
      const rightTime = document.getElementById("rightTime");
      const rightSign = document.getElementById("rightSign");
      const rightTicket = document.getElementById("rightTicket");
      const rightDisabled = document.getElementById("rightDisabled");

      // --- State Variables ---
      let deferredPrompt; // For Android install prompt
      let videoStream = null;
      let timersActive = false;
      let timerIntervals = [];
      let statusTimeout = null;
      let currentParkingSession = {};
      let map = null;
      let currentUserLocationMarker = null;
      let savedLocationMarker = null;
      let currentCoords = null;
      let watchId = null;
      let historyDetailMap = null;
      let alarmHasTriggered = false;

      // --- Constants ---
      const GEMINI_API_KEY = ""; // <--- IMPORTANT: Replace!
      const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
      const GEMINI_PROMPT = `Take a deep breath and look at the image provided.
For each parking sign(s) provided, return the following sections in order:

1. List All Visible Parking Signs
Include the sign details and the arrow direction (Left, Right, Both(which includes no arrows)).
Format:
 [Arrow Direction] Sign (#) - Time: [Minutes/unlimited/no parking] -- Sign it is referring to: [Sign details] -- Ticket: [Yes/No] -- Disabled: [Yes/No]

2. Determine Which Sign Applies Based on Current Time & Day
Current time: ${new Date().toLocaleString()}
Current day: ${new Date().toLocaleDateString("en-US", { weekday: "long" })}
If there are multiple signs that covers different time slots, use the one that applies to the current time.
If no sign is valid for the current time and there are no other restrictions, return "unlimited".
If there is a sign with “free parking” and another sign in the same time slot, the free parking applies.

3. Convert Parking Time to Minutes
"2P" → 120
"3P" → 180
"4P" → 240
"No Parking" / "No Stopping" / "Clearway" / "Zones, like Mail Zone, Police, etc" if it is in that time slot (or no time slot) → "no parking"
If no parking signs apply, return "unlimited"

4. Handle Ticket/Metered Parking
If the sign includes "ticket" or "meter" or any thing that indicates paid parking, return "Yes" for the Ticket field.

5. Handle Disability Parking
If the sign is a disabled parking sign, return "Yes" for the Disabled field and "no parking" for the Time field.

6. Return Final Left & Right Signs
For each side of the pole, based on the current time and the parking signs you listed out, determine the times the parking sign applies return the FINAL Left Sign and FINAL Right Sign in this format (even if the sign applies to both sides, still return both sides.):
 FINAL Left Sign - Time: [Minutes/unlimited/no parking] -- Sign Used: [Sign details] -- Reason: [Why you think this parking sign applies] -- Ticket: [Yes/No] -- Disabled: [Yes/No]
 FINAL Right Sign - Time: [Minutes/unlimited/no parking] -- Sign Used: [Sign details] -- Reason: [Why you think this parking sign applies] -- Ticket: [Yes/No] -- Disabled: [Yes/No]

IMPORTANT Clarifications:
Only Three Possible Arrow Directions:
Left Arrow → Only affects the left side of the pole.
Right Arrow → Only affects the right side of the pole.
Both Arrows → Applies to both sides, meaning there should be NO separate Left or Right sign interpretations—just one sign applying to both.

Example Scenarios & Expected Output for your better understanding:

Scenario 1
Signs:
Left Arrow: "2P Mon-Fri 1pm-6pm"
Left Arrow: "3P Mon-Fri 6am-1pm"
Right Arrow: "4P Sat-Sun"
Current Time: Monday 1:50pm
Expected Output:
FINAL Left Sign - Time: 120 -- Sign Used: Mon-Fri 1pm-6pm -- Reason: It is in that time slot -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: unlimited -- Sign Used: None -- Reason: It is not in any sign’s time slot -- Ticket: No -- Disabled: No

Scenario 2
Signs:
Left Arrow: "2P Mon-Fri 1pm-6pm ticket"
Right Arrow: "3P Mon-Fri 6am-1pm"
Current Time: Monday 12:30pm
Expected Output:
FINAL Left Sign - Time: unlimited -- Sign Used: None -- Reason: It is not in any sign’s time slot -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: 180 -- Sign Used: Mon-Fri 6am-1pm -- Reason: It is in that time slot -- Ticket: No -- Disabled: No

Scenario 3
Signs:
Left Arrow: "No Stopping"
Right Arrow: "2P Mon-Fri 1pm-6pm"
Current Time: Tuesday 3pm
Expected Output:
FINAL Left Sign - Time: no parking -- Sign Used: No Stopping -- Reason: No parking allowed -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: 120 -- Sign Used: Mon-Fri 1pm-6pm -- Reason: It is in that time slot -- Ticket: No -- Disabled: No

Scenario 4
Signs:
Left Arrow: "3P Sat-Sun"
Right Arrow: "2P Mon-Fri 1pm-6pm"
Current Time: Wednesday 10am
Expected Output:
FINAL Left Sign - Time: unlimited -- Sign Used: None -- Reason: It is not in any sign’s time slot -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: unlimited -- Sign Used: None -- Reason: It is not in any sign’s time slot -- Ticket: No -- Disabled: No

Scenario 5
Signs:
Left Arrow: "Mail Zone All Other Times"
Right Arrow: "2P Mon-Fri 1pm-6pm"
Current Time: Tuesday 3pm
Expected Output:
FINAL Left Sign - Time: no parking -- Sign Used: Mail Zone -- Reason: No parking allowed -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: 120 -- Sign Used: Mon-Fri 1pm-6pm -- Reason: It is in that time slot -- Ticket: No -- Disabled: No


Scenario 6: Multiple Signs on Both Sides (Metered Parking)
Signs:
Left Arrow:
"3P Mon-Fri 6am-1pm"
"2P Mon-Fri 1pm-6pm"
"4P Sat-Sun"
 Right Arrow:
"No Parking Mon-Fri 7am-9am"
"2P Mon-Fri 9am-6pm ticket"
"4P Sat-Sun ticket"
 Current Time: Monday, 10:30am
Expected Output:
FINAL Left Sign - Time: 180 -- Sign Used: Mon-Fri 6am-1pm -- Reason: It is in that time slot -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: 120 -- Sign Used: Mon-Fri 9am-6pm ticket -- Reason: It is in that time slot -- Ticket: Yes -- Disabled: No

Scenario 7: Sign with Both Arrows (Applies to Both Sides)
Signs:
Sign with Both Arrows: "3P"
Current Time: Any
Expected Output:
FINAL Left Sign - Time: 180 -- Sign Used: 3P -- Reason: It is in the sign’s time slot -- Ticket: No -- Disabled: No
FINAL Right Sign - Time: 180 -- Sign Used: 3P -- Reason: It is in the sign’s time slot -- Ticket: No -- Disabled: No

And to remind you again, the current time is:
Current time: ${new Date().toLocaleString()}
Current day: ${new Date().toLocaleDateString("en-US", { weekday: "long" })}


Thank you so much!`;

      // --- LocalStorage Helpers ---
      function getLocalStorage(key, defaultValue) {
        try {
          const v = localStorage.getItem(key);
          return v === null ? defaultValue : JSON.parse(v);
        } catch (e) {
          console.error(`LS Get Error [${key}]`, e);
          return defaultValue;
        }
      }
      function setLocalStorage(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error(`LS Set Error [${key}]`, e);
          showStatus("Error saving data.");
        }
      }

      // --- Settings ---
      let settings = {
        darkMode: getLocalStorage("parkEaseSettings_darkMode", false),
        disabilityPermit: getLocalStorage(
          "parkEaseSettings_disabilityPermit",
          false
        ),
        showAiDetails: getLocalStorage("parkEaseSettings_showAiDetails", false),
      };
      let parkingHistory = getLocalStorage("parkEaseHistory", []);
      function applyTheme(isDark) {
        body.classList.toggle("dark-mode", isDark);
        document
          .querySelector('meta[name="theme-color"]')
          .setAttribute("content", isDark ? "#0d1117" : "#4a90e2");
        settings.darkMode = isDark;
        setLocalStorage("parkEaseSettings_darkMode", isDark);
      }
      function applyDisability(hasPermit) {
        settings.disabilityPermit = hasPermit;
        setLocalStorage("parkEaseSettings_disabilityPermit", hasPermit);
        showStatus(
          `Disability Permit ${
            hasPermit ? "Enabled" : "Disabled"
          }. Retake photo if needed.`,
          3000
        );
      }
      function applyShowAiDetails(show) {
        settings.showAiDetails = show;
        setLocalStorage("parkEaseSettings_showAiDetails", show);
        const analysisDone =
          originalText.textContent &&
          originalText.textContent !== "Sending request to AI...";
        aiDetailsSection.style.display =
          show && analysisDone ? "block" : "none";
      }
      function renderHistory() {
        const listElement = document.getElementById("history-list");
        listElement.innerHTML = "";
        if (parkingHistory.length === 0) {
          listElement.innerHTML =
            '<li style="text-align: center; color: var(--text-light); background: none; border: none; cursor: default;">No history yet.</li>';
          clearHistoryBtn.style.display = "none";
          return;
        }
        clearHistoryBtn.style.display = "block";
        const sortedHistory = [...parkingHistory].sort(
          (a, b) => b.timestamp - a.timestamp
        );
        sortedHistory.forEach((item, index) => {
          const li = document.createElement("li");
          li.classList.add("history-entry");
          li.dataset.index = parkingHistory.findIndex(
            (h) => h.timestamp === item.timestamp
          );
          const date = new Date(item.timestamp);
          const formattedDate = date.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
          const formattedTime = date.toLocaleTimeString(undefined, {
            hour: "numeric",
            minute: "2-digit",
          });
          li.innerHTML = `<span class="date">${formattedDate} at ${formattedTime}</span><span class="details">Rule: ${
            item.rule
          } ${
            item.location
              ? `(${item.location.lat.toFixed(3)}, ${item.location.lng.toFixed(
                  3
                )})`
              : ""
          }</span>`;
          li.addEventListener("click", () => {
            historyModal.classList.remove("visible");
            setActiveNav(navStatusBtn);
            showHistoryDetail(li.dataset.index);
          });
          listElement.appendChild(li);
        });
      }
      function saveParkingSession(sessionData) {
        if (!sessionData.timestamp) {
          sessionData.timestamp = Date.now();
        }
        parkingHistory.push(sessionData);
        setLocalStorage("parkEaseHistory", parkingHistory);
      }
      function clearHistory() {
        if (confirm("Clear all parking history?")) {
          parkingHistory = [];
          setLocalStorage("parkEaseHistory", parkingHistory);
          renderHistory();
          showStatus("Parking history cleared.");
        }
      }
      function showHistoryDetail(index) {
        const item = parkingHistory[index];
        if (!item) return;
        historyDetailContent.innerHTML = `<p><strong>Date:</strong> ${new Date(
          item.timestamp
        ).toLocaleString()}</p><p><strong>Interpreted Rule:</strong> ${
          item.rule
        }</p>${
          item.location
            ? `<p><strong>Location:</strong> Lat: ${item.location.lat.toFixed(
                5
              )}, Lng: ${item.location.lng.toFixed(5)}</p>`
            : "<p>Location not recorded.</p>"
        }<p><strong>Sign Analysis:</strong> ${
          item.signInterpretation || "N/A"
        }</p>`;
        historyDetailModal.classList.add("visible");
        if (!historyDetailMap) {
          historyDetailMap = L.map(historyDetailMapEl);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "© OpenStreetMap",
          }).addTo(historyDetailMap);
        }
        if (item.location) {
          historyDetailMapEl.style.display = "block";
          const coords = L.latLng(item.location.lat, item.location.lng);
          historyDetailMap.setView(coords, 16);
          historyDetailMap.eachLayer((layer) => {
            if (layer instanceof L.Marker) historyDetailMap.removeLayer(layer);
          });
          L.marker(coords)
            .addTo(historyDetailMap)
            .bindPopup("Parked Location")
            .openPopup();
          setTimeout(() => {
            try {
              historyDetailMap.invalidateSize();
            } catch (e) {}
          }, 150);
        } else {
          historyDetailMapEl.style.display = "none";
        }
      }

      // --- Check if Running as PWA ---
      function isRunningStandalone() {
        return (
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone
        );
      }

      // --- Initialization Control ---
      function checkInstallationAndInitialize() {
        console.log("Checking installation status...");
        applyTheme(settings.darkMode); // Apply theme early for install gate

        if (isRunningStandalone()) {
          console.log("Running in standalone mode.");
          installGate.style.display = "none"; // Hide install gate
          // Proceed with full app initialization
          initializeAppCore();
        } else {
          console.log("Running in browser.");
          installGate.style.display = "flex"; // Ensure install gate is visible
          // Show appropriate install instructions
          detectOSAndShowInstructions();
          // DO NOT initialize the core app features yet
        }
      }

      // --- Core App Initialization (Called ONLY if installed) ---
      function initializeAppCore() {
        console.log("Initializing core app features...");
        // Apply other settings
        disabilityToggle.checked = settings.disabilityPermit;
        showAiDetailsToggle.checked = settings.showAiDetails;
        applyShowAiDetails(settings.showAiDetails); // Set initial AI visibility

        initCamera();
        initMap();

        // --- Event Listeners (for the main app) ---
        captureBtn.addEventListener("click", handleCapture);
        retakeBtn.addEventListener("click", handleRetake);
        navStatusBtn.addEventListener("click", () => {
          setActiveNav(navStatusBtn);
          settingsModal.classList.remove("visible");
          historyModal.classList.remove("visible");
          document.querySelector(".main-content").scrollTop = 0;
        });
        navHistoryBtn.addEventListener("click", () => {
          setActiveNav(navHistoryBtn);
          settingsModal.classList.remove("visible");
          renderHistory();
          historyModal.classList.add("visible");
        });
        navSettingsBtn.addEventListener("click", () => {
          setActiveNav(navSettingsBtn);
          historyModal.classList.remove("visible");
          settingsModal.classList.add("visible");
          document.querySelector("#settingsModal .modal-content").scrollTop = 0;
        });
        closeSettingsBtn.addEventListener("click", () => {
          settingsModal.classList.remove("visible");
          setActiveNav(navStatusBtn);
        });
        closeHistoryModalBtn.addEventListener("click", () => {
          historyModal.classList.remove("visible");
          setActiveNav(navStatusBtn);
        });
        closeHistoryDetailBtn.addEventListener("click", () =>
          historyDetailModal.classList.remove("visible")
        );
        darkModeToggle.addEventListener("change", (e) =>
          applyTheme(e.target.checked)
        );
        disabilityToggle.addEventListener("change", (e) =>
          applyDisability(e.target.checked)
        );
        showAiDetailsToggle.addEventListener("change", (e) =>
          applyShowAiDetails(e.target.checked)
        );
        clearHistoryBtn.addEventListener("click", clearHistory);
        cancelTicketTimeBtn.addEventListener("click", () =>
          ticketTimeModal.classList.remove("visible")
        );
        stopTimerBtn.addEventListener("click", handleStopTimer);

        // Collapsible AI details
        const coll = document.getElementsByClassName("collapsible");
        if (coll.length > 0) {
          coll[0].addEventListener("click", function () {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            if (content.style.maxHeight) {
              content.style.maxHeight = null;
            } else {
              content.style.display = "block";
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  content.style.maxHeight = content.scrollHeight + "px";
                });
              });
            }
          });
        }

        // Close modals on outside click
        window.addEventListener("click", (e) => {
          const closeAndResetNav = () => setActiveNav(navStatusBtn);
          if (e.target === settingsModal) {
            settingsModal.classList.remove("visible");
            closeAndResetNav();
          }
          if (e.target === historyModal) {
            historyModal.classList.remove("visible");
            closeAndResetNav();
          }
          if (e.target === signSelectionModal)
            signSelectionModal.classList.remove("visible");
          if (e.target === ticketTimeModal)
            ticketTimeModal.classList.remove("visible");
          if (e.target === historyDetailModal)
            historyDetailModal.classList.remove("visible");
        });

        setActiveNav(navStatusBtn); // Set initial active tab for the main app
        console.log("Core app initialized.");
      }

      // --- OS Detection and Install Prompt Logic ---
      function detectOSAndShowInstructions() {
        const ua = navigator.userAgent;
        // More robust iOS check
        const isIOS =
          /iPad|iPhone|iPod/.test(ua) ||
          (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
        const isAndroid = /Android/.test(ua);

        console.log(`OS Detection: iOS=${isIOS}, Android=${isAndroid}`);

        // Hide all prompts first
        iosInstallPrompt.style.display = "none";
        androidInstallPrompt.style.display = "none";
        otherOsPrompt.style.display = "none";

        if (isIOS) {
          console.log("Showing iOS instructions.");
          iosInstallPrompt.style.display = "block";
        } else if (isAndroid) {
          console.log("Showing Android instructions.");
          androidInstallPrompt.style.display = "block";
          // Button state handled by beforeinstallprompt listener
          installBtnAndroid.disabled = true; // Assume disabled until prompt is ready
          installBtnAndroid.textContent = "Install ParkEase"; // Default text
        } else {
          console.log("Showing fallback instructions.");
          otherOsPrompt.style.display = "block";
        }
      }

      // --- Bottom Nav Helper ---
      function setActiveNav(activeBtn) {
        allNavBtns.forEach((btn) => btn.classList.remove("active"));
        if (activeBtn) activeBtn.classList.add("active");
      }

      // --- Camera ---
      async function initCamera() {
        try {
          videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = videoStream;
          video.style.display = "block";
          capturedImage.style.display = "none";
          cameraSection.style.display = "block";
          mapSection.style.display = "none";
        } catch (err) {
          showStatus("Error accessing camera: " + err.message, 5000);
          console.error("Camera Error:", err);
        }
      }
      function stopCamera() {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
          videoStream = null;
        }
      }

      // --- Map ---
      function initMap() {
        map = L.map(mapEl).setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);
        const currentLocationIcon = L.divIcon({
          className: "current-location-marker",
          iconSize: [16, 16],
        });
        if ("geolocation" in navigator) {
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              currentCoords = L.latLng(
                position.coords.latitude,
                position.coords.longitude
              );
              if (!currentUserLocationMarker) {
                currentUserLocationMarker = L.marker(currentCoords, {
                  icon: currentLocationIcon,
                })
                  .addTo(map)
                  .bindPopup("You are here");
                if (!map.hasLayer(savedLocationMarker))
                  map.setView(currentCoords, 16);
              } else {
                currentUserLocationMarker.setLatLng(currentCoords);
              }
              if (mapSection.style.display === "block" && savedLocationMarker)
                map.fitBounds(
                  L.latLngBounds(
                    currentCoords,
                    savedLocationMarker.getLatLng()
                  ),
                  { padding: [40, 40], maxZoom: 17 }
                );
              else if (
                mapSection.style.display === "block" &&
                !savedLocationMarker
              )
                map.setView(currentCoords, 16);
            },
            (error) => {
              console.error("Geolocation error:", error);
              showStatus("Could not get location.", 3000);
              if (
                !map.hasLayer(currentUserLocationMarker) &&
                !map.hasLayer(savedLocationMarker)
              )
                map.setView([40.7128, -74.006], 10);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } else {
          showStatus("Geolocation is not supported.", 5000);
          map.setView([40.7128, -74.006], 10);
        }
      }
      function showMapAtParkedLocation() {
        mapSection.style.display = "block";
        cameraSection.style.display = "none";
        setTimeout(() => {
          if (map) {
            try {
              map.invalidateSize();
            } catch (e) {}
            if (currentCoords) {
              if (savedLocationMarker) map.removeLayer(savedLocationMarker);
              const savedLocationIcon = L.divIcon({
                className: "saved-location-marker",
                iconSize: [20, 20],
                iconAnchor: [10, 20],
              });
              savedLocationMarker = L.marker(currentCoords, {
                icon: savedLocationIcon,
              })
                .addTo(map)
                .bindPopup(
                  `<b>Parked Here</b><br>${new Date().toLocaleTimeString()}`
                )
                .openPopup();
              currentParkingSession.location = {
                lat: currentCoords.lat,
                lng: currentCoords.lng,
              };
              if (currentUserLocationMarker)
                map.fitBounds(
                  L.latLngBounds(
                    currentCoords,
                    currentUserLocationMarker.getLatLng()
                  ),
                  { padding: [40, 40], maxZoom: 17 }
                );
              else map.setView(currentCoords, 16);
            } else {
              showStatus("Location unknown, cannot mark on map.", 3000);
            }
          }
        }, 100);
      }

      // --- Capture & Analysis ---
      function handleCapture() {
        if (!videoStream) {
          showStatus("Camera not ready.", 3000);
          return;
        }
        if (timersActive) {
          if (
            !confirm(
              "A timer is active. Starting a new session will stop the current timer. Continue?"
            )
          )
            return;
          stopTimers();
        }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.9);
        capturedImage.src = imageDataUrl;
        capturedImage.style.display = "block";
        video.style.display = "none";
        stopCamera();
        captureBtn.style.display = "none";
        retakeBtn.style.display = "flex";
        try {
          silentAudio.play().catch((e) => {});
          alarmAudio.play().catch((e) => {});
        } catch (e) {}
        resetAnalysisAndTimer();
        currentParkingSession = {};
        showStatus("Analyzing sign...", 10000);
        analyzeImage(imageDataUrl);
        showMapAtParkedLocation();
        setActiveNav(navStatusBtn);
      }
      function handleRetake() {
        resetAnalysisAndTimer();
        stopTimers();
        capturedImage.style.display = "none";
        video.style.display = "block";
        captureBtn.style.display = "flex";
        retakeBtn.style.display = "none";
        mapSection.style.display = "none";
        cameraSection.style.display = "block";
        if (savedLocationMarker) {
          map.removeLayer(savedLocationMarker);
          savedLocationMarker = null;
        }
        if (currentUserLocationMarker)
          map.setView(currentUserLocationMarker.getLatLng(), 16);
        silenceAlarm();
        initCamera();
        showStatus("Ready to capture.");
        setActiveNav(navStatusBtn);
      }
      function resetAnalysisAndTimer() {
        updateSignGraph("left", "-", "-", false, false, false);
        updateSignGraph("right", "-", "-", false, false, false);
        leftSignHeader.className = "sign-header";
        leftSignHeader.textContent = "LEFT SIDE";
        rightSignHeader.className = "sign-header";
        rightSignHeader.textContent = "RIGHT SIDE";
        signGraphs.classList.remove("visible");
        timerCard.style.display = "none";
        timerCardContainer.style.display = "none";
        stopTimerBtn.style.display = "none";
        warningTimeEl.classList.remove("pulse");
        warningTimeEl.textContent = "00:00:00";
        expiryTimeEl.textContent = "";
        aiDetailsSection.style.display = "none";
        originalText.textContent = "";
        const collapsible = document.querySelector(".collapsible");
        if (collapsible) {
          collapsible.classList.remove("active");
          const content = collapsible.nextElementSibling;
          if (content) content.style.maxHeight = null;
        }
        signSelectionModal.classList.remove("visible");
        ticketTimeModal.classList.remove("visible");
      }
      async function analyzeImage(imageDataUrl) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY") {
          showStatus("API Key not configured.", 5000);
          originalText.textContent = "Error: API Key not configured.";
          applyShowAiDetails(true);
          return;
        }
        originalText.textContent = "Sending request to AI...";
        try {
          const response = await fetch(GEMINI_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    { text: GEMINI_PROMPT },
                    {
                      inline_data: {
                        mime_type: "image/jpeg",
                        data: imageDataUrl.split(",")[1],
                      },
                    },
                  ],
                },
              ],
            }),
          });
          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(
              `API request failed: ${response.status} ${response.statusText} - ${errorBody}`
            );
          }
          const result = await response.json();
          console.log("Gemini Raw Response:", result);
          if (result.error)
            throw new Error(result.error.message || "API Error");
          if (
            result.candidates &&
            result.candidates[0].finishReason &&
            result.candidates[0].finishReason !== "STOP"
          ) {
            const blockReason = result.candidates[0].finishReason;
            console.warn(`Analysis blocked. Reason: ${blockReason}`);
            throw new Error(`Analysis blocked due to ${blockReason}.`);
          }
          if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
            console.error("Unexpected API response structure:", result);
            throw new Error("Unexpected API response structure.");
          }
          const text = result.candidates[0].content.parts[0].text;
          originalText.textContent = text;
          applyShowAiDetails(settings.showAiDetails);
          showStatus("Analysis complete. Interpreting rules...", 3000);
          handleSignResponse(text);
        } catch (err) {
          console.error("Analysis error:", err);
          showStatus(`Analysis Error: ${err.message}`, 6000);
          originalText.textContent = `Error during analysis:\n${err.message}`;
          applyShowAiDetails(true);
          resetAnalysisAndTimer();
        }
      }
      function parseSignDetails(match) {
        if (!match) return null;
        return {
          time: match[1].trim(),
          sign: match[2].trim(),
          requiresTicket: match[3].trim().toLowerCase() === "yes",
          isDisabled: match[4].trim().toLowerCase() === "yes",
        };
      }
      function handleSignResponse(responseText) {
        try {
          const leftSignRegex =
            /FINAL\s+Left\s+Sign\s*-\s*Time:\s*(.*?)\s*--\s*Sign Used:\s*(.*?)\s*--\s*Ticket:\s*(Yes|No)\s*--\s*Disabled:\s*(Yes|No)/i;
          const rightSignRegex =
            /FINAL\s+Right\s+Sign\s*-\s*Time:\s*(.*?)\s*--\s*Sign Used:\s*(.*?)\s*--\s*Ticket:\s*(Yes|No)\s*--\s*Disabled:\s*(Yes|No)/i;
          const leftMatch = responseText.match(leftSignRegex);
          const rightMatch = responseText.match(rightSignRegex);
          const leftData = parseSignDetails(leftMatch);
          const rightData = parseSignDetails(rightMatch);
          console.log("Parsed Left:", leftData);
          console.log("Parsed Right:", rightData);
          currentParkingSession.signInterpretation = responseText;
          signGraphs.classList.add("visible");
          const hasDisabilityPermit = settings.disabilityPermit;
          const isEffectivelyAllowedLeft =
            leftData &&
            ((leftData.time.toLowerCase() !== "no parking" &&
              !leftData.isDisabled) ||
              (leftData.isDisabled && hasDisabilityPermit));
          const isEffectivelyAllowedRight =
            rightData &&
            ((rightData.time.toLowerCase() !== "no parking" &&
              !rightData.isDisabled) ||
              (rightData.isDisabled && hasDisabilityPermit));
          const isDisabilityOverrideLeft =
            isEffectivelyAllowedLeft &&
            leftData?.isDisabled &&
            leftData?.time.toLowerCase() === "no parking";
          const isDisabilityOverrideRight =
            isEffectivelyAllowedRight &&
            rightData?.isDisabled &&
            rightData?.time.toLowerCase() === "no parking";
          if (leftData) {
            updateSignGraph(
              "left",
              leftData.time,
              leftData.sign,
              leftData.requiresTicket,
              leftData.isDisabled,
              isEffectivelyAllowedLeft,
              isDisabilityOverrideLeft
            );
          } else {
            updateSignGraph("left", "Unknown", "N/A", false, false, false);
          }
          if (rightData) {
            updateSignGraph(
              "right",
              rightData.time,
              rightData.sign,
              rightData.requiresTicket,
              rightData.isDisabled,
              isEffectivelyAllowedRight,
              isDisabilityOverrideRight
            );
          } else {
            updateSignGraph("right", "Unknown", "N/A", false, false, false);
          }
          if (isEffectivelyAllowedLeft && isEffectivelyAllowedRight) {
            signSelectionModal.classList.add("visible");
            leftSignBtn.onclick = () => {
              signSelectionModal.classList.remove("visible");
              processParkingChoice(leftData, "Left", isDisabilityOverrideLeft);
            };
            rightSignBtn.onclick = () => {
              signSelectionModal.classList.remove("visible");
              processParkingChoice(
                rightData,
                "Right",
                isDisabilityOverrideRight
              );
            };
          } else if (isEffectivelyAllowedLeft) {
            showStatus("Parking possible on Left side.", 2000);
            processParkingChoice(leftData, "Left", isDisabilityOverrideLeft);
          } else if (isEffectivelyAllowedRight) {
            showStatus("Parking possible on Right side.", 2000);
            processParkingChoice(rightData, "Right", isDisabilityOverrideRight);
          } else {
            showStatus("No parking allowed here based on signs.", 4000);
            currentParkingSession.rule = "No Parking Allowed";
            saveParkingSession(currentParkingSession);
          }
        } catch (err) {
          console.error("Error handling sign response:", err);
          showStatus("Error interpreting sign data. Please retake.", 5000);
          resetAnalysisAndTimer();
        }
      }
      function processParkingChoice(
        signData,
        side,
        isDisabilityOverride = false
      ) {
        if (!signData) {
          showStatus(`Error: Invalid sign data for ${side} side.`, 4000);
          return;
        }
        console.log(
          `Processing parking for ${side} side:`,
          signData,
          `Disability Override: ${isDisabilityOverride}`
        );
        currentParkingSession.side = side;
        currentParkingSession.signDetails = signData;
        currentParkingSession.isDisabilityParking = isDisabilityOverride;
        let effectiveTime = isDisabilityOverride ? "Unlimited" : signData.time;
        if (signData.requiresTicket && !isDisabilityOverride) {
          showTicketTimeSelection(effectiveTime, side);
        } else {
          handleTimeSelection(
            effectiveTime,
            side,
            signData.requiresTicket && !isDisabilityOverride
          );
        }
      }
      function showTicketTimeSelection(maxTimeStr, side) {
        ticketTimeOptionsContainer.innerHTML = "";
        let maxMinutes = null;
        if (
          maxTimeStr &&
          maxTimeStr.toLowerCase() !== "unlimited" &&
          !isNaN(parseInt(maxTimeStr))
        ) {
          maxMinutes = parseInt(maxTimeStr);
        } else if (maxTimeStr && maxTimeStr.toLowerCase() === "unlimited") {
          maxMinutes = 240;
        } else {
          maxMinutes = 120;
        }
        if (maxMinutes <= 0) {
          showStatus(
            `Ticket required, but time limit is zero or invalid (${maxTimeStr}). Cannot park.`,
            5000
          );
          return;
        }
        for (let minutes = 30; minutes <= maxMinutes; minutes += 30) {
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          let timeLabel = "";
          if (hours > 0) timeLabel += `${hours}hr `;
          if (mins > 0) timeLabel += `${mins}min`;
          const btn = document.createElement("button");
          btn.classList.add("time-option-btn");
          btn.textContent = timeLabel.trim();
          btn.dataset.minutes = minutes;
          btn.onclick = () => {
            ticketTimeModal.classList.remove("visible");
            handleTimeSelection(minutes.toString(), side, true);
          };
          ticketTimeOptionsContainer.appendChild(btn);
        }
        ticketTimeModal.classList.add("visible");
      }
      function handleTimeSelection(timeStr, side, isTicketed = false) {
        let ruleDescription = "";
        if (timeStr === null || timeStr === undefined) {
          showStatus("Error: No time information available.", 4000);
          ruleDescription = "Error - Unknown Time";
          return;
        }
        const timeLower = timeStr.toString().toLowerCase();
        if (timeLower === "no parking") {
          showStatus(`No parking allowed on the ${side} side.`, 4000);
          ruleDescription = "No Parking";
        } else if (timeLower === "unlimited") {
          showStatus(
            `Unlimited parking on ${side} side.${
              isTicketed ? " (Ticket purchased)" : ""
            }${
              currentParkingSession.isDisabilityParking
                ? " (Disability Permit)"
                : ""
            }`,
            4000
          );
          ruleDescription = `Unlimited Parking${isTicketed ? " (Ticket)" : ""}${
            currentParkingSession.isDisabilityParking
              ? " (Disability Permit)"
              : ""
          }`;
          timerCardContainer.style.display = "none";
        } else {
          const minutes = parseInt(timeLower);
          if (!isNaN(minutes) && minutes > 0) {
            startTimers(minutes);
            ruleDescription = `${minutes} min Parking${
              isTicketed ? " (Ticket)" : ""
            }${
              currentParkingSession.isDisabilityParking
                ? " (Disability Permit)"
                : ""
            }`;
            showStatus(
              `Timer set for ${minutes} min on ${side} side.${
                isTicketed ? " (Ticket purchased)" : ""
              }${
                currentParkingSession.isDisabilityParking
                  ? " (Disability Permit)"
                  : ""
              }`,
              4000
            );
          } else {
            showStatus(
              `Could not determine parking time from "${timeStr}" on ${side} side.`,
              5000
            );
            ruleDescription = `Unknown Time (${timeStr})`;
            timerCardContainer.style.display = "none";
          }
        }
        currentParkingSession.rule = ruleDescription;
        saveParkingSession(currentParkingSession);
      }

      // --- Timers & Alarm ---
      function startTimers(totalMinutes) {
        stopTimers();
        const warningMinutes = Math.max(0, totalMinutes - 15);
        const now = Date.now();
        const warningEndTime = now + warningMinutes * 60 * 1000;
        const parkingEndTime = now + totalMinutes * 60 * 1000;
        const expiryDate = new Date(parkingEndTime);
        expiryTimeEl.textContent = `Expires: ${expiryDate.toLocaleTimeString(
          [],
          { hour: "numeric", minute: "2-digit" }
        )}`;
        function updateTimerDisplay() {
          const currentTime = Date.now();
          let warningTimeLeft = warningEndTime - currentTime;
          let parkingTimeLeft = parkingEndTime - currentTime;
          if (parkingTimeLeft <= 0) {
            warningTimeEl.textContent = "EXPIRED";
            expiryTimeEl.textContent = `Expired at: ${expiryDate.toLocaleTimeString(
              [],
              { hour: "numeric", minute: "2-digit" }
            )}`;
            if (!alarmHasTriggered) {
              triggerAlarm();
              alarmHasTriggered = true;
            }
          } else if (warningTimeLeft <= 0) {
            warningTimeEl.textContent = formatTime(parkingTimeLeft);
            if (!alarmHasTriggered) {
              triggerAlarm();
              alarmHasTriggered = true;
            }
            warningTimeEl.classList.add("pulse");
          } else {
            warningTimeEl.textContent = formatTime(warningTimeLeft);
            warningTimeEl.classList.remove("pulse");
          }
        }
        alarmHasTriggered = false;
        timerIntervals.push(setInterval(updateTimerDisplay, 1000));
        updateTimerDisplay();
        timersActive = true;
        timerCardContainer.style.display = "block";
        timerCard.style.display = "block";
        stopTimerBtn.style.display = "block";
      }
      function handleStopTimer() {
        if (
          confirm("Are you sure you want to stop the current parking timer?")
        ) {
          stopTimersActions();
        }
      }
      function stopTimersActions() {
        timerIntervals.forEach((intervalId) => clearInterval(intervalId));
        timerIntervals = [];
        timersActive = false;
        alarmHasTriggered = false;
        silenceAlarm();
        stopTimerBtn.style.display = "none";
        timerCard.style.display = "none";
        timerCardContainer.style.display = "none";
        warningTimeEl.classList.remove("pulse");
        warningTimeEl.textContent = "00:00:00";
        expiryTimeEl.textContent = "";
        showStatus("Timer stopped.", 2000);
      }
      function stopTimers() {
        stopTimersActions();
      }
      function formatTime(ms) {
        if (ms <= 0) return "00:00:00";
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      }
      function triggerAlarm() {
        if (!alarmAudio.src.includes("sample2.mp3")) {
          console.log("Triggering alarm sound...");
          alarmAudio.src =
            "https://filesamples.com/samples/audio/mp3/sample2.mp3";
          alarmAudio.load();
          alarmAudio
            .play()
            .catch((e) => console.error("Alarm play failed:", e));
        } else if (alarmAudio.paused) {
          alarmAudio
            .play()
            .catch((e) => console.error("Alarm restart failed:", e));
        }
      }
      function silenceAlarm() {
        if (!alarmAudio.src.includes("silence.mp3")) {
          console.log("Silencing alarm sound...");
          alarmAudio.pause();
          alarmAudio.src =
            "https://cdn.glitch.global/16c2e168-5f80-4256-858b-ebbfd77da240/5-seconds-of-silence.mp3?v=1739673346964";
          alarmAudio.load();
          alarmAudio.play().catch((e) => {});
        }
      }

      // --- UI Updates ---
      function showStatus(message, duration = 3000) {
        console.log("Status:", message);
        if (statusTimeout) clearTimeout(statusTimeout);
        status.textContent = message;
        status.classList.add("visible");
        statusTimeout = setTimeout(() => {
          status.classList.remove("visible");
        }, duration);
      }
      function updateSignGraph(
        side,
        timeValue,
        signUsed,
        ticketRequired,
        disabledOnly,
        isParkingAllowed,
        isDisabilityOverride = false
      ) {
        const header = side === "left" ? leftSignHeader : rightSignHeader;
        const timeEl = side === "left" ? leftTime : rightTime;
        const signEl = side === "left" ? leftSign : rightSign;
        const ticketEl = side === "left" ? leftTicket : rightTicket;
        const disabledEl = side === "left" ? leftDisabled : rightDisabled;
        timeEl.textContent = timeValue || "N/A";
        signEl.textContent = signUsed || "N/A";
        ticketEl.textContent = ticketRequired ? "Yes" : "No";
        disabledEl.textContent = disabledOnly ? "Yes" : "No";
        let headerClass = "sign-header";
        let headerText = `${side.toUpperCase()} SIDE`;
        if (isDisabilityOverride) {
          headerClass += " disabled-allowed";
          headerText += ` - DISABLED PERMIT OK`;
        } else if (!isParkingAllowed) {
          headerClass += " no-parking";
          headerText += ` - NO PARKING (${
            disabledOnly && !settings.disabilityPermit
              ? "Permit Req."
              : timeValue
          })`;
        } else if (ticketRequired) {
          headerClass += " ticket";
          headerText += ` - TICKET REQ. (${timeValue})`;
        } else if (timeValue.toLowerCase() === "unlimited") {
          headerClass += " allowed";
          headerText += " - UNLIMITED";
        } else if (!isNaN(parseInt(timeValue))) {
          headerClass += " allowed";
          headerText += ` - ${timeValue} MIN`;
        } else {
          headerClass += " no-parking";
          headerText += ` - Check Sign (${timeValue})`;
        }
        header.className = headerClass;
        header.textContent = headerText;
      }

      // --- Service Worker ---
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((reg) => console.log("SW registered.", reg))
            .catch((err) => console.log("SW registration failed:", err));
        });
      }

      // --- PWA Install Prompt Listener (runs regardless of install state) ---
      window.addEventListener("beforeinstallprompt", (e) => {
        console.log("beforeinstallprompt event captured.");
        e.preventDefault(); // Prevent the mini-infobar
        deferredPrompt = e; // Store the event
        // Enable the Android install button IF the gate is visible
        if (
          installGate.style.display !== "none" &&
          androidInstallPrompt.style.display !== "none"
        ) {
          console.log("Enabling Android install button.");
          installBtnAndroid.disabled = false;
          installBtnAndroid.textContent = "Install ParkEase";
        }
      });

      // --- Android Install Button Listener (in the gate) ---
      installBtnAndroid.addEventListener("click", async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt(); // Show the install prompt
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to the install prompt: ${outcome}`);
          // Optionally hide the button or gate after prompting,
          // but the app access relies on reload/next visit in standalone mode.
          if (outcome === "accepted") {
            console.log("User accepted the install prompt");
            // Maybe show a message like "Install started, please open the app from your home screen."
            installBtnAndroid.textContent = "Installing...";
            installBtnAndroid.disabled = true;
          } else {
            console.log("User dismissed the install prompt");
          }
          deferredPrompt = null; // Prompt can only be used once
        } else {
          console.log("Install prompt not available or already used.");
          installBtnAndroid.textContent = "Install Unavailable";
          installBtnAndroid.disabled = true;
        }
      });

      // --- Initial Check & Run ---
      document.addEventListener(
        "DOMContentLoaded",
        checkInstallationAndInitialize
      );
    </script>
  </body>
</html>
